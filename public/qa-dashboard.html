<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Zeta AI Live QA Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body { font-family: Arial; background: #f7f7f7; margin: 20px; }
    h1 { color: #333; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 30px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #4CAF50; color: white; }
    tr:nth-child(even) { background-color: #f2f2f2; }
    .PASS { background-color: #c8e6c9; font-weight: bold; }
    .FAIL { background-color: #ffcdd2; font-weight: bold; }
    .NEWFAIL { background-color: #ff8a65; font-weight: bold; animation: pulse 2s infinite; }
    .chart-container { width: 400px; margin-bottom: 40px; }
    .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
    .status-live { background-color: #4CAF50; }
    .status-updating { background-color: #FF9800; animation: blink 1s infinite; }
    @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.3; } }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
</style>
</head>
<body>
<h1>Zeta AI Live QA Dashboard</h1>
<div id="statusIndicator">
    <span class="status-indicator status-live"></span>
    <span id="lastUpdated">Loading...</span>
</div>

<div id="summaryStats" style="margin: 20px 0; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <h2>Summary Statistics</h2>
    <div style="display: flex; gap: 20px; margin-top: 10px;">
        <div><strong>Total Tests:</strong> <span id="totalTests">0</span></div>
        <div><strong>Passed:</strong> <span id="passedTests" style="color: #4CAF50;">0</span></div>
        <div><strong>Failed:</strong> <span id="failedTests" style="color: #F44336;">0</span></div>
        <div><strong>Pass Rate:</strong> <span id="passRate">0%</span></div>
    </div>
</div>

<div id="dashboard"></div>

<script>
let previousFailures = new Set();
let charts = {};

async function fetchResults() {
    try {
        // Try API first, fallback to direct JSON
        let response;
        try {
            response = await fetch('/api/qa-results');
        } catch {
            response = await fetch('kilo_qa_checklist_results.json?_=' + new Date().getTime());
            const jsonData = await response.json();
            // Convert API format to HTML format
            return convertApiFormat(jsonData);
        }
        return await response.json();
    } catch(e) {
        console.error("Error fetching results:", e);
        return [];
    }
}

async function fetchTrends() {
    try {
        response = await fetch('qa_trends.json?_=' + new Date().getTime());
        return await response.json();
    } catch(e) {
        console.error("Error fetching trends:", e);
        return null;
    }
}

function convertApiFormat(apiData) {
    // Convert the API format to the HTML format expected
    return [{
        module: "Zeta AI System Tests",
        tests: apiData.results.map(result => ({
            test_case: result.name,
            expected_result: "Test should " + (result.status === 'passed' ? "pass" : "be fixed"),
            pass_fail: result.status === 'passed' ? 'PASS' : 'FAIL',
            notes: result.details || ""
        }))
    }];
}

function updateSummaryStats(data) {
    let totalTests = 0, passed = 0, failed = 0;

    data.forEach(module => {
        module.tests.forEach(test => {
            totalTests++;
            if (test.pass_fail === 'PASS') passed++;
            else if (test.pass_fail === 'FAIL') failed++;
        });
    });

    document.getElementById('totalTests').textContent = totalTests;
    document.getElementById('passedTests').textContent = passed;
    document.getElementById('failedTests').textContent = failed;
    document.getElementById('passRate').textContent = totalTests > 0 ? ((passed / totalTests) * 100).toFixed(1) + '%' : '0%';
}

function renderDashboard(data) {
    const dashboardDiv = document.getElementById("dashboard");
    dashboardDiv.innerHTML = "";

    data.forEach(module => {
        let moduleDiv = document.createElement("div");
        moduleDiv.style.cssText = "margin-bottom: 40px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);";

        moduleDiv.innerHTML = `<h2 style="color: #333; margin-bottom: 20px;">${module.module}</h2>`;

        // Table
        let table = document.createElement("table");
        let header = table.insertRow();
        ["Test Case","Expected Result","Pass/Fail","Notes"].forEach(text=>{
            let th = document.createElement("th"); th.innerText = text; header.appendChild(th);
        });

        let passCount = 0, failCount = 0;

        module.tests.forEach(test=>{
            let row = table.insertRow();
            let testId = module.module + "::" + test.test_case;
            let status = test.pass_fail || "";
            let wasPreviouslyFailed = previousFailures.has(testId);

            if(status === "FAIL" && !wasPreviouslyFailed) status = "NEWFAIL";
            if(status === "PASS") passCount++; else failCount++;

            row.insertCell().innerText = test.test_case;
            row.insertCell().innerText = test.expected_result || "";
            let cell = row.insertCell(); cell.innerText = test.pass_fail; cell.className = status;
            row.insertCell().innerText = test.notes || "";

            // Update previousFailures set
            if(test.pass_fail === "FAIL") previousFailures.add(testId);
            else previousFailures.delete(testId);
        });

        moduleDiv.appendChild(table);

        // Pie Chart
        let chartContainer = document.createElement("div");
        chartContainer.className = "chart-container";
        let canvas = document.createElement("canvas");
        chartContainer.appendChild(canvas);
        moduleDiv.appendChild(chartContainer);

        let chartKey = module.module;
        if(!charts[chartKey]){
            charts[chartKey] = new Chart(canvas, {
                type: 'pie',
                data: {
                    labels: ['PASS','FAIL'],
                    datasets: [{
                        data: [passCount,failCount],
                        backgroundColor:['#4CAF50','#F44336'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive:true,
                    plugins:{
                        legend:{ position:'bottom' },
                        title:{ display:true, text: module.module + ' Pass/Fail Distribution' }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });
        } else {
            charts[chartKey].data.datasets[0].data = [passCount,failCount];
            charts[chartKey].update('active');
        }

        dashboardDiv.appendChild(moduleDiv);
    });
}

function renderTrendCharts(trends) {
    if (!trends) return;

    // Overall Pass Rate Trend
    const overallTrendDiv = document.createElement("div");
    overallTrendDiv.style.cssText = "margin-bottom: 40px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);";

    overallTrendDiv.innerHTML = `<h2 style="color: #333; margin-bottom: 20px;">Pass Rate Trends</h2>`;

    const overallCanvas = document.createElement("canvas");
    overallTrendDiv.appendChild(overallCanvas);

    // Trend Analysis Info
    const analysisDiv = document.createElement("div");
    analysisDiv.style.cssText = "margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;";
    analysisDiv.innerHTML = `
        <h3 style="margin: 0 0 10px 0; color: #333;">Trend Analysis</h3>
        <p style="margin: 5px 0;"><strong>Overall Trend:</strong>
            <span style="color: ${trends.trend_analysis.overall_trend === 'improving' ? '#4CAF50' : '#F44336'};">
                ${trends.trend_analysis.overall_trend}
            </span>
        </p>
        <p style="margin: 5px 0;"><strong>Predicted Next Rate:</strong> ${trends.trend_analysis.predicted_next_rate}%</p>
        <p style="margin: 5px 0;"><strong>Confidence:</strong> ${(trends.trend_analysis.confidence * 100).toFixed(1)}%</p>
    `;
    overallTrendDiv.appendChild(analysisDiv);

    // Module-specific trends
    const moduleTrendDiv = document.createElement("div");
    moduleTrendDiv.style.cssText = "margin-top: 20px;";
    moduleTrendDiv.innerHTML = `<h3 style="color: #333; margin-bottom: 15px;">Module Performance Trends</h3>`;

    const moduleCanvas = document.createElement("canvas");
    moduleTrendDiv.appendChild(moduleCanvas);
    overallTrendDiv.appendChild(moduleTrendDiv);

    // Create Overall Trend Chart
    const overallLabels = trends.pass_rate_history.map(point =>
        new Date(point.timestamp).toLocaleTimeString()
    );
    const overallData = trends.pass_rate_history.map(point => point.pass_rate);

    if (!charts['overall_trend']) {
        charts['overall_trend'] = new Chart(overallCanvas, {
            type: 'line',
            data: {
                labels: overallLabels,
                datasets: [{
                    label: 'Overall Pass Rate %',
                    data: overallData,
                    borderColor: '#2196F3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: 'Overall Pass Rate Trend' },
                    legend: { display: true }
                },
                scales: {
                    y: { beginAtZero: false, min: 70, max: 100 }
                },
                animation: { duration: 1000 }
            }
        });
    } else {
        charts['overall_trend'].data.labels = overallLabels;
        charts['overall_trend'].data.datasets[0].data = overallData;
        charts['overall_trend'].update('active');
    }

    // Create Module Trends Chart
    const moduleLabels = trends.pass_rate_history.map(point =>
        new Date(point.timestamp).toLocaleTimeString()
    );

    const datasets = Object.keys(trends.module_trends).map(moduleName => {
        const moduleData = trends.module_trends[moduleName].map(point => point.pass_rate);
        return {
            label: moduleName,
            data: moduleData,
            borderColor: getRandomColor(),
            backgroundColor: 'transparent',
            tension: 0.4
        };
    });

    if (!charts['module_trends']) {
        charts['module_trends'] = new Chart(moduleCanvas, {
            type: 'line',
            data: {
                labels: moduleLabels,
                datasets: datasets
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: 'Module Performance Trends' },
                    legend: { display: true, position: 'bottom' }
                },
                scales: {
                    y: { beginAtZero: false, min: 70, max: 100 }
                },
                animation: { duration: 1000 }
            }
        });
    } else {
        charts['module_trends'].data.labels = moduleLabels;
        charts['module_trends'].data.datasets = datasets;
        charts['module_trends'].update('active');
    }

    return overallTrendDiv;
}

function getRandomColor() {
    const colors = ['#4CAF50', '#F44336', '#2196F3', '#FF9800', '#9C27B0', '#00BCD4'];
    return colors[Math.floor(Math.random() * colors.length)];
}

async function updateDashboard(){
    const statusIndicator = document.querySelector('.status-indicator');
    statusIndicator.className = 'status-indicator status-updating';

    try {
        const [results, trends] = await Promise.all([
            fetchResults(),
            fetchTrends()
        ]);

        renderDashboard(results);
        updateSummaryStats(results);

        // Add trend charts
        const dashboardDiv = document.getElementById("dashboard");
        const existingTrendDiv = document.getElementById("trend-charts");
        if (existingTrendDiv) {
            existingTrendDiv.remove();
        }

        const trendDiv = renderTrendCharts(trends);
        if (trendDiv) {
            trendDiv.id = "trend-charts";
            dashboardDiv.insertBefore(trendDiv, dashboardDiv.firstChild);
        }

        let now = new Date().toLocaleString();
        document.getElementById("lastUpdated").innerText = "Last updated: " + now;
        statusIndicator.className = 'status-indicator status-live';
    } catch (error) {
        console.error('Dashboard update failed:', error);
        document.getElementById("lastUpdated").innerText = "Update failed: " + new Date().toLocaleString();
        statusIndicator.className = 'status-indicator';
        statusIndicator.style.backgroundColor = '#F44336';
    }
}

// Initial load
updateDashboard();

// Update every 5 seconds
setInterval(updateDashboard, 5000);

// Handle visibility change to pause/resume updates
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        // Pause updates when tab is not visible
        console.log('Pausing updates - tab hidden');
    } else {
        // Resume updates when tab becomes visible
        console.log('Resuming updates - tab visible');
        updateDashboard();
    }
});
</script>
</body>
</html>